# Trigger Batch 알고리즘 문서

> **Last Updated**: 2025-01-04
> **File**: `trigger_batch.py`
> **Purpose**: 급등주/모멘텀 종목 자동 스크리닝

---

## 목차

1. [개요](#1-개요)
2. [공통 필터](#2-공통-필터)
3. [오전 트리거 (Morning)](#3-오전-트리거-morning)
4. [오후 트리거 (Afternoon)](#4-오후-트리거-afternoon)
5. [복합 점수 계산](#5-복합-점수-계산)
6. [사용법](#6-사용법)
7. [trading_agents 궁합 분석](#7-trading_agents-궁합-분석)

---

## 1. 개요

### 목적

`trigger_batch.py`는 매일 오전/오후에 실행되어 **관심 종목 후보**를 자동으로 선별합니다. 선별된 종목은 이후 AI 분석 파이프라인(`stock_analysis_orchestrator.py`)으로 전달됩니다.

### 실행 흐름

```
trigger_batch.py (종목 스크리닝)
    ↓
stock_analysis_orchestrator.py (AI 분석)
    ↓
stock_tracking_agent.py (매수/매도 결정)
    ↓
trading/domestic_stock_trading.py (실제 주문)
```

### 데이터 소스

- **pykrx**: KRX(한국거래소) 공식 데이터
- **스냅샷 데이터**: OHLCV (시가, 고가, 저가, 종가, 거래량, 거래대금)
- **시가총액 데이터**: 종목별 시가총액

---

## 2. 공통 필터

모든 트리거에 적용되는 기본 필터입니다.

### 2.1 절대적 기준 필터 (`apply_absolute_filters`)

| 필터 | 기준 | 목적 |
|------|------|------|
| 최소 거래대금 | 5억원 이상 | 유동성 확보 |
| 최소 거래량 | 시장 평균의 20% 이상 | 거래 활성화 종목 |

```python
def apply_absolute_filters(df, min_value=500000000):
    filtered = df[df['거래대금'] >= min_value]
    avg_volume = df['거래량'].mean()
    filtered = filtered[filtered['거래량'] >= avg_volume * 0.2]
    return filtered
```

### 2.2 시가총액 필터

| 필터 | 기준 | 목적 |
|------|------|------|
| 최소 시가총액 | 500억원 이상 | 동전주/소형주 제외 |

### 2.3 저유동성 필터 (`filter_low_liquidity`)

거래량 하위 N% 종목 제외 (기본값: 20%)

---

## 3. 오전 트리거 (Morning)

오전 배치는 **장 시작 후** 실행되며, 3개 트리거에서 각 1개씩 총 3개 종목을 선별합니다.

### 3.1 거래량 급증 상위주 (`trigger_morning_volume_surge`)

**목적**: 전일 대비 거래량이 급증한 종목 포착

#### 선별 조건

| 조건 | 기준 |
|------|------|
| 거래량 증가율 | 전일 대비 30% 이상 |
| 상승 여부 | 시가 대비 현재가 상승 |
| 거래대금 | 5억원 이상 |
| 시가총액 | 500억원 이상 |

#### 복합 점수

```
복합점수 = 거래량증가율(60%) + 절대거래량(40%)
```

#### 로직 흐름

```
1. 전일 대비 거래량 비율 계산
2. 거래량 30%+ 증가 종목 필터링
3. 복합 점수 계산 및 상위 N개 선정
4. 상승세 종목만 최종 선별 (2차 필터)
5. 상위 3개 반환
```

---

### 3.2 눌림목 매수 대기 상위주 (`trigger_morning_pullback_buy`) ⭐ NEW

**목적**: 상승 추세 확인 후 조정 구간에서 매수 기회 포착

> **Note**: 기존 `trigger_morning_gap_up_momentum`을 대체하는 새 트리거입니다.
> `trading_agents.py`와의 궁합을 최적화하기 위해 설계되었습니다.

#### 설계 철학

| 기존 갭상승 트리거 | 새 눌림목 트리거 |
|---|---|
| 이미 상승한 종목 선별 | 조정 중인 종목 선별 |
| 손절가(지지선) 멀음 | 손절가(최근 저점) 가까움 |
| 손익비 불리 | 손익비 2:1+ 확보 용이 |
| 추격 매수 성격 | 눌림목 분할매수 성격 |

#### 선별 조건

| 조건 | 기준 | 목적 |
|------|------|------|
| 추세 상승 | 최근 5일 중 3일+ 양봉 | 상승 추세 확인 |
| 눌림목 시작 | 당일 시가 ≤ 전일 종가 | 조정/갭다운 진입 |
| 반등 중 | 당일 종가 > 시가 | 매수세 유입 확인 |
| 거래량 유지 | 전일 대비 70% 이상 | 관심 지속 |
| 과열 아님 | RSI 추정치 70 미만 | 과열 종목 제외 |
| 지지선 거리 | 10% 이내 | 손익비 확보 |

#### 복합 점수

```
복합점수 = 추세강도(40%) + 반등강도(30%) + 거래량안정성(30%)
```

#### 멀티데이 분석

5일간의 데이터를 분석하여:
- **양봉 일수**: 5일 중 양봉(종가 > 시가) 일수
- **누적 상승률**: 5일간 총 등락률
- **최근 5일 고점/저점**: 지지선/저항선 파악
- **RSI 추정치**: 간이 RSI 계산

#### 로직 흐름

```
1. 멀티데이 스냅샷 조회 (5일치)
2. 각 종목별 양봉 일수, 누적 상승률, 고점/저점 계산
3. 추세 상승 종목 필터링 (5일 중 3일+ 양봉)
4. 당일 눌림목 + 반등 종목 필터링
5. 과열 종목 제외 (RSI 70+)
6. 지지선 거리 10% 이내 필터링
7. 복합 점수 계산 및 상위 3개 반환
```

---

### 3.3 기존: 갭 상승 모멘텀 상위주 (`trigger_morning_gap_up_momentum`) [LEGACY]

**목적**: 갭 상승으로 시작한 모멘텀 종목 포착

> **Note**: `--legacy-gap` 옵션으로만 사용 가능. 기본값은 눌림목 트리거.

#### 선별 조건

| 조건 | 기준 |
|------|------|
| 갭상승률 | 전일 종가 대비 1% 이상 |
| 상승 지속 | 현재가 > 시가 |
| 거래대금 | 5억원 이상 |
| 시가총액 | 500억원 이상 |

#### 복합 점수

```
복합점수 = 갭상승률(50%) + 장중등락률(30%) + 거래대금(20%)
```

---

### 3.4 시총 대비 집중 자금 유입 상위주 (`trigger_morning_value_to_cap_ratio`)

**목적**: 시가총액 대비 비정상적으로 높은 거래대금이 유입된 종목 포착

#### 선별 조건

| 조건 | 기준 |
|------|------|
| 거래대금비율 | 거래대금 / 시가총액 |
| 상승 여부 | 시가 대비 현재가 상승 |
| 거래대금 | 5억원 이상 |
| 시가총액 | 500억원 이상 |

#### 복합 점수

```
복합점수 = 거래대금비율(50%) + 절대거래대금(30%) + 장중등락률(20%)
```

---

## 4. 오후 트리거 (Afternoon)

오후 배치는 **장 마감 후** 실행되며, 3개 트리거에서 각 1개씩 총 3개 종목을 선별합니다.

### 4.1 일중 상승률 상위주 (`trigger_afternoon_daily_rise_top`)

**목적**: 당일 가장 강하게 상승한 종목 포착

#### 선별 조건

| 조건 | 기준 |
|------|------|
| 장중등락률 | 시가 대비 3% 이상 상승 |
| 거래대금 | 10억원 이상 (강화) |
| 시가총액 | 500억원 이상 |

#### 복합 점수

```
복합점수 = 장중등락률(60%) + 거래대금(40%)
```

---

### 4.2 마감 강도 상위주 (`trigger_afternoon_closing_strength`)

**목적**: 종가가 고가에 가까운(강한 마감) 종목 포착

#### 선별 조건

| 조건 | 기준 |
|------|------|
| 마감 강도 | (종가 - 저가) / (고가 - 저가) |
| 거래량 증가 | 전일 대비 거래량 증가 |
| 상승 여부 | 시가 대비 종가 상승 |
| 거래대금 | 5억원 이상 |
| 시가총액 | 500억원 이상 |

#### 마감 강도 계산

```python
마감강도 = (종가 - 저가) / (고가 - 저가)
# 1에 가까울수록 강한 마감 (종가 ≈ 고가)
# 0에 가까울수록 약한 마감 (종가 ≈ 저가)
```

#### 복합 점수

```
복합점수 = 마감강도(50%) + 거래량증가율(30%) + 거래대금(20%)
```

---

### 4.3 거래량 증가 상위 횡보주 (`trigger_afternoon_volume_surge_flat`)

**목적**: 거래량은 급증했지만 가격은 횡보하는 종목 포착 (세력 매집 의심)

#### 선별 조건

| 조건 | 기준 |
|------|------|
| 거래량 증가율 | 전일 대비 50% 이상 |
| 횡보 여부 | 장중등락률 ±5% 이내 |
| 거래대금 | 5억원 이상 |
| 시가총액 | 500억원 이상 |

#### 복합 점수

```
복합점수 = 거래량증가율(60%) + 거래대금(40%)
```

---

## 5. 복합 점수 계산

### 정규화 방식

모든 지표는 0~1 사이로 정규화됩니다:

```python
normalized = (value - min) / (max - min)
```

### 가중치 적용

```python
복합점수 = Σ (정규화된_지표 × 가중치)
```

### 최종 선별 로직 (`select_final_tickers`)

1. 각 트리거에서 최상위 종목 1개씩 선택 (최대 3개)
2. 3개 미만이면 전체 복합 점수 순으로 추가
3. 중복 종목 제거

---

## 6. 사용법

### 기본 실행

```bash
# 오전 배치 (새 눌림목 트리거 사용)
python trigger_batch.py morning INFO

# 오후 배치
python trigger_batch.py afternoon INFO
```

### 옵션

```bash
# JSON 결과 저장
python trigger_batch.py morning INFO --output result.json

# 기존 갭상승 트리거 사용 (레거시)
python trigger_batch.py morning INFO --legacy-gap

# 디버그 모드
python trigger_batch.py morning DEBUG
```

### 출력 예시 (JSON)

```json
{
  "거래량 급증 상위주": [
    {
      "code": "005930",
      "name": "삼성전자",
      "current_price": 75000,
      "change_rate": 3.5,
      "volume": 15000000,
      "trade_value": 1125000000000,
      "volume_increase": 150.5
    }
  ],
  "눌림목 매수 대기 상위주": [
    {
      "code": "000660",
      "name": "SK하이닉스",
      "current_price": 180000,
      "change_rate": 1.2,
      "bullish_days": 4,
      "gap_rate": -0.8,
      "intraday_change": 1.5,
      "support_distance": 5.2,
      "rsi_estimate": 62
    }
  ],
  "metadata": {
    "run_time": "2025-01-04T10:30:00",
    "trigger_mode": "morning",
    "trade_date": "20250103",
    "trigger2_type": "pullback"
  }
}
```

---

## 7. trading_agents 궁합 분석

### 문제점 (기존)

`trigger_batch.py`가 선별한 종목이 `trading_agents.py`에서 대부분 **관망** 처리되는 문제가 있었습니다.

#### 근본 원인

| trigger_batch 특성 | trading_agents 요구사항 | 충돌 |
|---|---|---|
| 이미 상승 중인 종목 선별 | 손익비 2:1 이상 필요 | 상승 후 진입 시 손익비 불리 |
| 갭상승 1%+ 종목 선별 | 손절폭 -7% 이내 우선 | 갭상승 후 지지선이 멀어짐 |
| 거래량 급증 + 상승 조건 | 저평가(밸류에이션) 확인 | 급등주는 이미 고평가 |

#### 실제 데이터 (2025년 12월)

```
총 분석 종목: 54개
매수 결정: 0개 (0%)
관망 결정: 46개 (85%)
평균 점수: 5.41점
```

### 해결책: 눌림목 트리거

새로운 `trigger_morning_pullback_buy` 트리거는 다음을 개선합니다:

| 항목 | 기존 갭상승 | 새 눌림목 |
|---|---|---|
| 진입 시점 | 상승 중 | 조정 중 |
| 손절가 거리 | 멀음 | 가까움 (최근 5일 저점) |
| 손익비 | 불리 | 2:1+ 확보 용이 |
| 밸류에이션 | 급등 후 고평가 | 조정 시점 상대적 저평가 |
| 과열 종목 | 포함 | RSI 70+ 제외 |

### 기대 효과

1. **매수 결정 비율 증가**: 손익비 요건 충족 용이
2. **리스크 감소**: 지지선 가까워 손절 시 손실 최소화
3. **수익률 개선**: 조정 후 반등 시 상승 여력 확보

---

## 부록: 함수 목록

| 함수명 | 카테고리 | 설명 |
|--------|----------|------|
| `get_snapshot` | 데이터 | 당일 OHLCV 조회 |
| `get_previous_snapshot` | 데이터 | 전일 OHLCV 조회 |
| `get_multi_day_snapshots` | 데이터 | N일치 OHLCV 조회 |
| `get_market_cap_df` | 데이터 | 시가총액 조회 |
| `apply_absolute_filters` | 필터 | 절대적 기준 필터 |
| `filter_low_liquidity` | 필터 | 저유동성 필터 |
| `normalize_and_score` | 점수 | 정규화 및 복합점수 |
| `enhance_dataframe` | 유틸 | 종목명/업종 추가 |
| `trigger_morning_volume_surge` | 오전 | 거래량 급증 |
| `trigger_morning_pullback_buy` | 오전 | 눌림목 매수 (NEW) |
| `trigger_morning_gap_up_momentum` | 오전 | 갭상승 (LEGACY) |
| `trigger_morning_value_to_cap_ratio` | 오전 | 시총 대비 자금유입 |
| `trigger_afternoon_daily_rise_top` | 오후 | 일중 상승률 |
| `trigger_afternoon_closing_strength` | 오후 | 마감 강도 |
| `trigger_afternoon_volume_surge_flat` | 오후 | 거래량 증가 횡보 |
| `select_final_tickers` | 선별 | 최종 종목 선택 |
| `run_batch` | 실행 | 배치 실행 |

---

**Document Version**: 1.0
**Author**: PRISM-INSIGHT Development Team
